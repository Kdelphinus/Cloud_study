# 03. AWS 컴퓨트 - EC2, Lambda, ECS

## EC2, EBS

### EC2(Elastic Computer Cloud)

- AWS 대표 서비스
- 스토리지, 네트워크, 보안 등 서버 속성 제어
- 최소의 시간 투자, 서버의 각종 환경 설정 가능
- 간단한 서버 획득, 부팅 작업, 대량의 서버 배포
- 워크로드에 따라 신속하게 스케일업/스케일다운 가능

### 주요 내용

- AMI: 가상 서버 생성용 이미지
- EBS: (서버 SW가 설치되는) 블록 스토리지
- ASG: 서버 확장 및 축소 자동화
- ELB: 요청량에 따라 다수의 서버에 부하 분산
- VPC: 기업 전용 가상 네트워크

### AMI

- 가상 서버의 S/W 구성 정보를 포함한 설계도
- OS, 앱 서버 S/W, 응용 S/W 등 세부 요소 포함
- 기업 업무에 최적화된 AMI(golden image)를 이용하여 해외 지사 등에 신속하게 다수의 가상 서버를 배포 가능
- AWS 배포 AMI / 마켓플레이스 AMI / 커뮤니티 AMI 선택 가능
- AMI를 이용해서 하나의 인스턴스 혹은 다수의 인스턴스로 구성된 호스트 서버를 생성할 수 있다.
- 인스턴스 자체를 다른 곳에 보낼 수는 없으나 AMI를 통해서 같은 인스턴스를 생성할 수 있다.

#### 부팅 방식별 AMI 유형

- 인스턴스 스토어 기반 AMI: S3에 저장된 부팅 이미지로 EC2 인스턴스 시작
- EBS 기반 AMI: EBS 볼륨에 저장된 부팅 이미지로 EC2 인스턴스 시작

#### 환경설정 옵션

- OS: Linux, Windows, Mac OS
- 연산 및 입출력 성능: CPU, RAM
- 스토리지: Instance Store, EBS, EFS
- 네트워크: VPC, CIDR, Subnet, IGW
- 방화벽: SG(Security Group)
- 초기 서버 환경설정: user-data

### EC2 인스턴스 타입 예시

- `m5.xlarge`
  - m: 인스턴스 클래스
  - 5: 세대 버전
  - xlarge: 해당 클래스 내에서 등급

### EC2 인스턴스 구매 옵션

- 온디맨드: 1년 미만, 사용량 예측이 어려운 경우
- 예약: 1년 이상, 사용량 예측이 용이한 경우, 3가지 세부 옵션
- 스팟: 입찰 방식으로 저렴, 단기적 활용, 작업 중단 대비해야 한다.
  - 온디맨드보다 훨씬 저렴한 비용으로 제공되는 예비 EC2 용량
  - 스팟 인스턴스의 장기적 수요/공급에 따라 이용료 자동 조정
  - 데이터 분석, 배치 작업, 백그라운드 프로세싱 등의 작업에 적합
- 전용 인스턴스: 고객 전용 하드웨어 할당(OS 제어 X)
- 전용 호스트: 고객 요구에 맞춘 커스텀 하드웨어(3년)

### EC2 멀티 테넌시 모델(multi-tenancy)

- 하드웨어 리소스 가상화, 다수 사용자가 공유
- 하나의 물리적 서버, 다수의 EC2 인스턴스 실행
- 16CPU 서버 생성 요청 -> 16CPU 리소스 할당
- 전용 물리 서버 대비 성능 저하 가능성이 높다
- 기본적인 업부 환경(클라우드를 쓴다): 공유 테넌시(Shared-tenancy)
- 엄격한 격리 필요 시(엄격한 보안이 필요하다): 전용 테넌시(Dedicated-tenancy)

### EC2 인스턴스의 스토리지

- 인스턴스에 부착하여 사용하는 볼륨 스토리지
- EBS 볼륨
  - 네트워크 드라이브 볼륨 역할
  - EC2의 물리적인 서버와 별개로 존재하며 연결했다 끊었다 할 수 있다.
- 인스턴스 스토어
  - 하드 드라이브 볼륨 역할
  - 즉, EC2의 물리적인 서버 내에 있는 볼륨
  - 작업량이 많을수록 입출력 속도가 다른 볼륨에 비해서 월등히 빠르다.
  - 호스트 서버가 내려가면 스토어 내에 저장된 데이터도 같이 사라진다.


### EBS 볼륨

- 인스턴스를 위한 네트워크 드라이브, AZ(가용 영역) 단위
- 인스턴스 종료 후에도 볼륨 데이터 유지(지속형)
- 한 번에 하나의 인스턴스에만 부착 가능

#### EBS 볼륨 타입

- 범용 스토리지(gp2/gp3 SSD)
  - PIOPS보다 비용 효율적
  - 저비용 고성능
  - 개발 및 테스트 워크로드에서 주로 사용
- PIOPS 스토리지(io1/io2 PIOPS SSD)
  - I/O 처리성능 최대화
  - IOPS(I/O 처리) 자원 소모
  - DB 워크로드
  - 본격적인 프로덕션에서 주로 사용
- 마그네틱 스토리지(st1/sc1 HDD)
  - 저렴
  - 중요성이 낮은 워크로드에 주로 사용
  - st1: 입출력 빈도가 낮은 빅데이터, 데이터웨어하우스 등에서 주로 사용

### 인스턴스 스토어(instance store)

- EC2 인스턴스에 고정된 고성능 하드 디스크
- 인스턴스와 생애주기가 동일한 스토리지(단명형)
- IOPS 성능은 EBS 대비 월등히 뛰어남
- 버퍼, 캐시 용으로 적합
- 무료이지만 안정성을 위해 EBS 등에 백업 혹은 복제를 권장

### 확장성(Scalability)

- 수직적 확장성
  - H/W 업그레이드 컨셉
  - 인스턴스 용량 상향 또는 하향
  - t2.micro -> t2.large 로 변경하는 등
  - 데이터베이스(비분산형 시스템)는 기본적으로 수직적 확장성에 맞춰저 있다.
  - RDS, ElasticCache 등의 서비스도 수직적 확장이 필요하다.
- 수평적 확장성
  - 탄력성(elasticity)
  - 인스턴스의 수 증가 또는 감소
  - 웹 앱, 모바일 앱 등 현대 분산형 시스템(트래픽이 많으면 늘리고 적으면 줄이고)
  - ASG, ELB로 구현

### 가용성(Availability)

- 재난 상황 속에서 운영/데이터 손실 최소화
- 멀티 AZ, 중복 구현(Redundancy)
- 능동적 가용성: 멀티 AZ ASG
- 수동적 사용성: 멀티 AZ RDS

### EC2 Auto Scaling

- 워크로드에 따라 EC2 인스턴스를 자동으로 증가 또는 감소시킴
- 오토스케일링 그룹, 시작 템플릿, 조정 정책 등의 요소가 필요하다.
- 인스턴스의 증감이 자유롭기 때문에 내오류성(오류가 발생했을 때 견딜 수 있는 정도) 향상, 가용성 향상, 비용 절감
- 미디어, 엔터테인먼트 산업 등 가변적 수요에 대응하기 쉽다.
- 조정 정책: 수동, 일정(예약), 온디맨드(동적)

#### Auto Scaling Group(ASG)

- 아래와 같은 옵션으로 크기를 조정할 수 있다.
  - Minimum size: 최소 가져야 할 인스턴스 개수
  - Desired capacity: 원하는 적정량의 인스턴스 개수
  - Maximum size: 최대 가질 수 있는 인스턴스 개수
- 동적으로 저정이 가능하다.
  - Target-tracking: 대상 지표의 목표값(ex.CPU 활성량이 60%가 되면 어떻게 해라...)
  - Step-scaling: 알람 수준에 따라 조정(알람 수에 따라 조정)
  - Simple-scaling: 알람 시 지정 크기 증가(알람이 오면 조정)
- Auto Scaling의 시작 시, 어떤 상황에서 어떤 템플릿을 사용할 것인지에 대해 시작 템플릿(Launch template)을 정의한다.
  - 각 상황에 맞춰 시작 템플릿을 여러 개 정의할 수 있다.

### Load Balancer(로드 밸런서)

- 트래픽 로드를 다수의 인스턴스에 분산하는 역할
- 앱에 DNS 등 단일 접속 지점 제공
- 트래픽 분산 관리, 인스턴스 헬스체크
- SSL(HTTPS) 기반 보안성 연결 제공
- private 트래픽과 public 트래픽 별도 관리 가능
- 멀티 AZ 기반 고가용성 실현 가능

#### AWS ELB(Elastic Load Balancer)

- 관리형 로드 밸런서(기능에 따라 ALB, NLB, GLB로 나눠져 있음)
  - 사용자가 일부 제어하고 나저미는 AWS가 자동으로 처리
- EC2, ASG, ECS, CloudWatch 앞에서 연결하는 역할
- Route53, WAF, Global Accelerator 등과 연계
- 헬스 체크: 로드 밸런서가 인스턴스에 응답 요청를 해서 상태 체크
  - 응답이 없으면 해당 인스턴스로 트래픽을 요청하지 않음

### EC2 인스턴스의 네트워크 구성

- 인스턴스 시작 시, VPC에서 서브넷 선택
- 서브넷, IPv4 주소(기본 프라이빗 IP 주소)
- 탄력적 IP 주소(영구, 고정 퍼블릭 IP 주소)
- 네트워크 성능 향상을 위해 배치 그룹을 사용할 수도 있다.

### 보안 그룹(SG, Security Groups)

- EC2 인스턴스 방화벽
- 서브넷의 NACL과 함께 네트워크 보안의 주요 요소
- EC2 인스턴스로 유입/유출되는 트래픽 통제
- 허용(Allow) 규칙만 적용 가능
  - 허용, 불허가 모두 가능한 것은 NACL(Network ACL)
- 기본 보안 그룹
  - 인바운드 규칙: EC2 인스턴스로 들어오는 것에 대한 규칙
  - 아웃바운드 규칙: EC2 인스턴스에서 나가는 것에 대한 규칙

#### 특징

- 기본 보안 그룹은 모든 아웃바운드 트래픽 허용
- 기본적으론 스테이트풀(요청 응답은 규칙 무관, 전달 허용): 들어온 것을 이미 알고 있기에 나가는 것을 따로 막지 않는 상태
- 보안 그룹의 규칙은 언제든지 추가 또는 삭제 가능
- 다수의 규칙 존재 시, 가장 허용적인 규칙을 적용한다.


## PaaS, 서버리스, 컨테이너, EKS, ECS

### PaaS(Platform-as-a-Service)

- 웹 앱의 개발 속도를 높일 수 있는 프리빌트-백엔드(출시 속도 향상)
- 공통된 부분(로그인 등)의 백엔드를 미리 만들어 둔 것
- 앱 개발자가 앱 서비스를 개발 및 제공하는 데 필요한 제반 요소 제공
- Dev tools, OS, Middleware, DB, App service Infra 등이 포함되어 있다.
- 서버리스 컨셉과 유사성이 있다. (스케일링 방식은 차이가 있음)


### Elastic Beanstalk

- PaaS, 인프라 프로비저닝 없이 신속하게 웹 앱 배포 및 스케일링
- 앱을 위한 모바일 API 백엔드 구현, 자동 패치 및 업그레이드를 지원한다.
- 레거시에서 중요한 비즈니스 앱 마이그레이션 용도로도 많이 사용된다.
- 개발 옵션: Java, .NET, Node js, Python 등 지원
- 플랫폼 위에 코드를 얹게 되면 AWS에서 지원하는 배포환경을 편하게 사용할 수 있다.

### 서버리스(Serverless)

- 서버 배포 및 관리 필요성 없이 코드 실행, 데이터 관리, 앱 통합 가능
- 정확히는 개발자 입장에서 관리할 서버가 없다는 의미다.
- 자동 크기 조정, 고가용성, 종량제 결제 모델
- 민첩성 향상, 비용 최적화(과잉 프로비저닝 감소)
- Lambda, Fargate, EventBridge, SQS, API Gateway, S3, DynamoDB, Aurora Serverless, Redshift Serverless 등 많은 서비스가 서버리스다.

#### Lambda

- 이벤트 기반 서버리스 컴퓨팅 서비스
- 예를 들어 사진을 업로드할 때, 크기를 조정하여 서버에 저장하는 동작을 해주는 것이 람다
- 인프라 프로비저닝 없이 코드를 실행한다. (FaaS)
- 고도의 확장성, 연속적 스케일링

### 컨테이너(Container)

- 하나의 컨테이너는 앱과 앱 실행에 필요한 시스템 라이브러리, 시스템 설정 및 기타 종속성 요소를 모두 포함
- 컨테이너화된 앱은 호스팅 위치에 관계없이 동일한 방식으로 실행
- 컨테이너화된 각각의 환경은 하나의 앱만 실행. 커널은 공유하지만 시스템의 다른 요소와 상호작용하지 않도록 동작됨

#### ECS(Elastic Container Server)

- 컨테이너화 앱의 배포, 관리, 크기 조정
- 완전관리형 컨테이너 오케스트레이션 서비스
- CI/CD, 자동화 도구와 연계하여 수천 개의 컨테이너를 시작 및 관리
- 비용 절감: 자율 프로비저닝, ALB 통합 오토스케일링, 종량제 요금
- ECS만 독자로 사용할 수는 없으며 EC2나 Fargate 등 컴퓨트 리소스 위에서 컨테이너 프로비저닝을 할 수 있다.
- ECR: 컨테이너 저장, 관리, 배포 서비스

#### Fargate

- 서버리스 기반 컨테이너 워크로드 실행 및 크기 조정
- 컨테이너를 EC2 인스턴스 등 인프라 위에 프로비전 할 필요가 없어짐
- CPU / RAM 용량 기반으로 컨테이너 실행만 하면 된다.

#### EKS(Elastic Kubernetes Service)

- 오픈소스 컨테이너 오케스트레이션 플랫폼인 Kubernetes 기반 서비스
- 컨테이너화 앱의 배포, 확장, 관리 자동화 서비스
- Kubernetes 컨트롤 플레인 및 노드 설치, 운영, 관리 부담 감소
- 고가용성: 멀티 AZ 기반 컨트롤 플레인 실행 및 크기 조정